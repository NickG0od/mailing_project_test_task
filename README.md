# _mailing_project_test_task
## Документация по тестовому проекту (задание от компании «Фабрика Решений»)

### Выполнил проект: Шавандрин Николай

Проект представляет собой сервис управления рассылками API администрирования и получения статистики.

#### Запуск проекта:
- Склонировать проект или загрузить к себе в папку.
- Создать env (виртуальную среду) для Python.
- Активировать только что созданную среду.
- Установить пакеты из файла "requirements.txt"
- В ./mailing/settings.py подключить свою БД.
- Установить миграции: python manage.py makemigrations, python manage.py migrate.
- Запустить сервер: python manage.py runserver 80
- Войти через ЛК администрации: localhost/admin.
- Готово

#### Структура проекта:

- Название проекта: mailing
  - Название приложения: mailing\_\_mailing. Содержит в себе модель «Mailing» и основную логику для сущности «Рассылка».
  - Название приложения: mailing\_\_client. Содержит в себе модель «Client» и основную логику для сущности «Клиент».
  - Название приложения: mailing\_\_message. Содержит в себе модель «Message» и основную логику для сущности «Сообщение».

#### Описание моделей:

- Mailing
  - Id DjangoDefaultPK уникальный id рассылки
  - start\_date DateTimeField дата и время запуска рассылки
  - msg\_textCharField текст сообщения для доставки клиенту
  - properties\_filterJSONField фильтр свойств клиентов, на которых должна быть произведена рассылка (код мобильного оператора, тег)
  - end\_dateDateTimeField дата и время окончания рассылки
- Client
  - Id DjangoDefaultPK уникальный id клиента
  - phone\_number CharField номертелефонаклиента
  - mobile\_operator\_code CharField кодмобильногооператора
  - tags TaggableManager тег (произвольная метка)
  - timezone CharField часовой пояс
- Message
  - IdDjangoDefaultPK уникальный id сообщения
  - sending\_date DateTimeField дата и время создания (отправки)
  - sending\_status IntegerField статус отправки
  - mailing ForeignKey id рассылки, в рамках которой было отправлено сообщение
  - client ForeignKey id клиента, которому отправили

Структура и логика каждого приложения реализована в REST стиле (при помощи DjangoRESTFramework-а).

Подробнее каждый запрос можно просмотреть по ссылке: \<link\>/docs/

В данном проекте использовалась библиотека «apscheduler» для реализации планировщика сообщений. После того как пользователь создаст новый объект «Рассылка», будет проверяться актуальность новой рассылки по дате и времени (дата и время в UTC формате). Если текущая дата попадает в нужный диапазон, то происходит отправка сообщения на внешний API и запись в модель «Сообщения» о инициализации отправки (статус: 0 (В ожидании)). Если время ещё не наступило, то добавляется новая задача в планировщик, дата и время запуска – есть дата и время начала рассылки.

Если статус ответа при запросе на внешний API не равен 200 или код в теле ответа не равен 0, значит произошла какая-то ошибка на внешнем сервисе. В таком случае будет добавлена новая задача – повторить запрос с тем же id сообщения через 25 сек. Так будет происходить до тех пор, пока текущая дата не будет больше конечной даты рассылки, что приведёт к изменению статуса сообщения на -1 (Ошибка). При положительном ответе от внешнего сервера статус сообщения изменится на 1 (Успешно).

#### Выполненные дополнительные задания:

- сделать так, чтобы по адресу /docs/ открывалась страница со Swagger UI и в нём отображалось описание разработанного API. Проверить можно, перейдя по ссылке: …/docs/
- реализовать администраторский Web UI для управления рассылками и получения статистики по отправленным сообщениям. Чтобы зайти в ЛК перейдите по ссылке: …/admin и введите "username" и "password" (Отправлю отдельно в телеграмме).
- удаленный сервис может быть недоступен, долго отвечать на запросы или выдавать некорректные ответы. Необходимо организовать обработку ошибок и откладывание запросов при неуспехе для последующей повторной отправки. Задержки в работе внешнего сервиса никак не должны оказывать влияние на работу сервиса рассылок. Реализовано через механизм планировщика сообщений («apscheduler»).

